name: Deploy to Server

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup SSH Key
        run: |
          echo "${{ secrets.PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: Test SSH Connection
        run: ssh -v -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo SSH connection successful"

      - name: Deploy to Server
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e  # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘ ì—ëŸ¬ ë°œìƒ ì‹œ ì¤‘ë‹¨

          echo "ðŸ” í˜„ìž¬ ìœ„ì¹˜: $(pwd)"
          echo "ðŸ“‚ í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™"
          cd /home/${{ secrets.SSH_USER }}/my-app || exit

          echo "ðŸ”„ ìµœì‹  ì½”ë“œ Pull"
          git fetch --all
          git reset --hard origin/main
          git pull origin main

          echo "ðŸ”¨ Gradle Build (í…ŒìŠ¤íŠ¸ ì œì™¸)"
          ./gradlew build -x test

          echo "ðŸ›‘ ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ"
          PID=$(pgrep -f 'java -jar' || true)
          if [ -n "$PID" ]; then
            echo "ðŸ”» ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ (PID: $PID)"
            kill -9 $PID
          else
            echo "âœ… ì‹¤í–‰ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì—†ìŒ"
          fi

          echo "ðŸš€ ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰"
          nohup java -jar build/libs/*.jar > output.log 2>&1 &
          EOF
