name: 🚀 Deploy Spring Boot to EC2

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v3

      - name: 🔑 Set up SSH & Deploy to EC2
        run: |
          echo "${{ secrets.PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem

          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e  # 스크립트 실행 중 에러 발생 시 중단

          echo "🔍 현재 위치: $(pwd)"
          echo "📂 프로젝트 폴더로 이동"
          cd /home/ubuntu/my-app || exit

          echo "🔄 최신 코드 Pull"
          git fetch --all
          git reset --hard origin/main
          git pull origin main

          echo "🔨 Gradle Build (테스트 제외)"
          ./gradlew build -x test

          echo "🛑 기존 애플리케이션 종료"
          PID=$(pgrep -f 'java -jar' || true)
          if [ -n "$PID" ]; then
            echo "🔻 기존 애플리케이션 종료 (PID: $PID)"
            kill -9 $PID
          else
            echo "✅ 실행 중인 애플리케이션 없음"
          fi

          echo "🚀 새 애플리케이션 실행"
          nohup java -jar build/libs/*.jar > output.log 2>&1 &
          EOF

      - name: 🧹 Cleanup Private Key
        run: rm -f private_key.pem
